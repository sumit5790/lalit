pipeline{
       agent any
       
	  stages {
		 stage ('build') {
		 
		    agent {
				docker {
                                    image '172.31.30.63:5000/maven'
				    registryUrl 'https://172.31.30.63:5000'
	                            registryCredentialsId 'private-docker'
	                            args '-v /root/.m2:/root/.m2'
		 }
                              }
			 steps {
			    echo "docker"
			 }     
}
	
        stage('test') {
            steps {
                // Print all the environment variables.
               sh 'docker build -f $(pwd)/Dockerfile -t 172.31.30.63:5000/image .'
            }
        }

		stage('Push') {
            when {
                branch 'master'
            }
            steps {
                  echo 'Deploying docker images'
		  sh 'docker tag 172.31.30.63:5000 172.31.30.63:5000/new_image '
                  sh 'docker push 172.31.30.63:5000/new_image:latest'
            }
        }
    }
}
